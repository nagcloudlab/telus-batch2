<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>TransferService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Transfer Service (Comprehensive Unit Tests)</a> &gt; <a href="index.source.html" class="el_package">com.npci.transfer.service</a> &gt; <span class="el_source">TransferService.java</span></div><h1>TransferService.java</h1><pre class="source lang-java linenums">package com.npci.transfer.service;

import com.npci.transfer.dto.TransferRequest;
import com.npci.transfer.dto.TransferResponse;
import com.npci.transfer.entity.Account;
import com.npci.transfer.entity.Transaction;
import com.npci.transfer.exception.AccountNotFoundException;
import com.npci.transfer.exception.InsufficientBalanceException;
import com.npci.transfer.exception.InvalidTransferException;
import com.npci.transfer.exception.InvalidAmountException;
import com.npci.transfer.repository.AccountRepository;
import com.npci.transfer.repository.TransactionRepository;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.math.BigDecimal;
import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;
import java.util.Random;

/**
 * Transfer Service - Business Logic Layer
 * 
 * Responsibilities:
 * - Execute transfer business logic
 * - Validate transfers
 * - Calculate fees
 * - Create transactions
 * 
 * Follows Single Responsibility Principle (S in SOLID)
 */
@Service
<span class="fc" id="L35">@RequiredArgsConstructor</span>
<span class="fc" id="L36">@Slf4j</span>
public class TransferService {
    
    private final AccountRepository accountRepository;
    private final TransactionRepository transactionRepository;
    private final FeeCalculator feeCalculator;
    
<span class="fc" id="L43">    private static final BigDecimal MIN_AMOUNT = new BigDecimal(&quot;1&quot;);</span>
<span class="fc" id="L44">    private static final BigDecimal MAX_AMOUNT = new BigDecimal(&quot;100000&quot;);</span>
    
    /**
     * Initiates a money transfer between two accounts.
     * 
     * @param request Transfer request containing source, destination, amount
     * @return TransferResponse with transaction details
     * @throws AccountNotFoundException if source or destination account not found
     * @throws InsufficientBalanceException if source account has insufficient balance
     * @throws InvalidTransferException if transfer is invalid
     */
    @Transactional
    public TransferResponse initiateTransfer(TransferRequest request) {
<span class="fc" id="L57">        log.info(&quot;Initiating transfer from {} to {} for amount {}&quot;,</span>
<span class="fc" id="L58">            request.getSourceUPI(), request.getDestinationUPI(), request.getAmount());</span>
        
        // Step 1: Validate request
<span class="fc" id="L61">        validateTransfer(request);</span>
        
        // Step 2: Find accounts
<span class="fc" id="L64">        Account source = findAccount(request.getSourceUPI(), &quot;Source&quot;);</span>
<span class="fc" id="L65">        Account destination = findAccount(request.getDestinationUPI(), &quot;Destination&quot;);</span>
        
        // Step 3: Calculate fee
<span class="fc" id="L68">        BigDecimal fee = feeCalculator.calculateFee(request.getAmount());</span>
<span class="fc" id="L69">        BigDecimal totalDebited = request.getAmount().add(fee);</span>
        
<span class="fc" id="L71">        log.debug(&quot;Fee calculated: {}, Total to debit: {}&quot;, fee, totalDebited);</span>
        
        // Step 4: Check balance
<span class="fc" id="L74">        validateBalance(source, totalDebited);</span>
        
        // Step 5: Execute transfer
<span class="fc" id="L77">        executeTransfer(source, destination, request.getAmount(), totalDebited);</span>
        
        // Step 6: Save accounts
<span class="fc" id="L80">        accountRepository.save(source);</span>
<span class="fc" id="L81">        accountRepository.save(destination);</span>
        
        // Step 7: Create transaction record
<span class="fc" id="L84">        Transaction transaction = createTransaction(request, fee, totalDebited);</span>
<span class="fc" id="L85">        transactionRepository.save(transaction);</span>
        
<span class="fc" id="L87">        log.info(&quot;Transfer completed successfully. Transaction ID: {}&quot;, </span>
<span class="fc" id="L88">            transaction.getTransactionId());</span>
        
        // Step 8: Build response
<span class="fc" id="L91">        return buildResponse(transaction);</span>
    }
    
    /**
     * Validates the transfer request.
     */
    private void validateTransfer(TransferRequest request) {
        // Check if source and destination are the same
<span class="fc bfc" id="L99" title="All 2 branches covered.">        if (request.getSourceUPI().equals(request.getDestinationUPI())) {</span>
<span class="fc" id="L100">            throw new InvalidTransferException(&quot;Cannot transfer to the same account&quot;);</span>
        }
        
        // Validate amount range
<span class="fc bfc" id="L104" title="All 2 branches covered.">        if (request.getAmount().compareTo(MIN_AMOUNT) &lt; 0) {</span>
<span class="fc" id="L105">            throw new InvalidAmountException(</span>
<span class="fc" id="L106">                String.format(&quot;Minimum transfer amount is ₹%s&quot;, MIN_AMOUNT));</span>
        }
        
<span class="fc bfc" id="L109" title="All 2 branches covered.">        if (request.getAmount().compareTo(MAX_AMOUNT) &gt; 0) {</span>
<span class="fc" id="L110">            throw new InvalidAmountException(</span>
<span class="fc" id="L111">                String.format(&quot;Maximum per-transaction limit is ₹%s&quot;, MAX_AMOUNT));</span>
        }
<span class="fc" id="L113">    }</span>
    
    /**
     * Finds an account by UPI ID.
     */
    private Account findAccount(String upiId, String accountType) {
<span class="fc" id="L119">        return accountRepository.findByUpiId(upiId)</span>
<span class="fc" id="L120">            .orElseThrow(() -&gt; new AccountNotFoundException(</span>
<span class="fc" id="L121">                String.format(&quot;%s account not found: %s&quot;, accountType, upiId)));</span>
    }
    
    /**
     * Validates if source account has sufficient balance.
     */
    private void validateBalance(Account source, BigDecimal totalRequired) {
<span class="fc bfc" id="L128" title="All 2 branches covered.">        if (source.getBalance().compareTo(totalRequired) &lt; 0) {</span>
<span class="fc" id="L129">            throw new InsufficientBalanceException(</span>
<span class="fc" id="L130">                String.format(&quot;Insufficient balance. Available: ₹%s, Required: ₹%s&quot;,</span>
<span class="fc" id="L131">                    source.getBalance(), totalRequired));</span>
        }
<span class="fc" id="L133">    }</span>
    
    /**
     * Executes the actual transfer by updating account balances.
     */
    private void executeTransfer(Account source, Account destination, 
                                 BigDecimal amount, BigDecimal totalDebited) {
        // Debit from source (including fee)
<span class="fc" id="L141">        source.setBalance(source.getBalance().subtract(totalDebited));</span>
        
        // Credit to destination (amount only, fee is kept by system)
<span class="fc" id="L144">        destination.setBalance(destination.getBalance().add(amount));</span>
        
<span class="fc" id="L146">        log.debug(&quot;Source new balance: {}, Destination new balance: {}&quot;,</span>
<span class="fc" id="L147">            source.getBalance(), destination.getBalance());</span>
<span class="fc" id="L148">    }</span>
    
    /**
     * Creates a transaction record.
     */
    private Transaction createTransaction(TransferRequest request, 
                                         BigDecimal fee, BigDecimal totalDebited) {
<span class="fc" id="L155">        Transaction transaction = new Transaction();</span>
<span class="fc" id="L156">        transaction.setTransactionId(generateTransactionId());</span>
<span class="fc" id="L157">        transaction.setSourceUPI(request.getSourceUPI());</span>
<span class="fc" id="L158">        transaction.setDestinationUPI(request.getDestinationUPI());</span>
<span class="fc" id="L159">        transaction.setAmount(request.getAmount());</span>
<span class="fc" id="L160">        transaction.setFee(fee);</span>
<span class="fc" id="L161">        transaction.setTotalDebited(totalDebited);</span>
<span class="fc" id="L162">        transaction.setStatus(&quot;SUCCESS&quot;);</span>
<span class="fc" id="L163">        transaction.setRemarks(request.getRemarks());</span>
<span class="fc" id="L164">        transaction.setTimestamp(LocalDateTime.now());</span>
<span class="fc" id="L165">        return transaction;</span>
    }
    
    /**
     * Generates a unique transaction ID.
     */
    private String generateTransactionId() {
<span class="fc" id="L172">        LocalDateTime now = LocalDateTime.now();</span>
<span class="fc" id="L173">        String datePart = now.format(DateTimeFormatter.ofPattern(&quot;yyyyMMdd&quot;));</span>
<span class="fc" id="L174">        String timePart = now.format(DateTimeFormatter.ofPattern(&quot;HHmmss&quot;));</span>
<span class="fc" id="L175">        String randomPart = String.format(&quot;%04d&quot;, new Random().nextInt(9999));</span>
<span class="fc" id="L176">        return &quot;TXN-&quot; + datePart + &quot;-&quot; + timePart + &quot;-&quot; + randomPart;</span>
    }
    
    /**
     * Builds the transfer response.
     */
    private TransferResponse buildResponse(Transaction transaction) {
<span class="fc" id="L183">        return TransferResponse.builder()</span>
<span class="fc" id="L184">            .transactionId(transaction.getTransactionId())</span>
<span class="fc" id="L185">            .status(transaction.getStatus())</span>
<span class="fc" id="L186">            .sourceUPI(transaction.getSourceUPI())</span>
<span class="fc" id="L187">            .destinationUPI(transaction.getDestinationUPI())</span>
<span class="fc" id="L188">            .amount(transaction.getAmount())</span>
<span class="fc" id="L189">            .fee(transaction.getFee())</span>
<span class="fc" id="L190">            .totalDebited(transaction.getTotalDebited())</span>
<span class="fc" id="L191">            .timestamp(transaction.getTimestamp())</span>
<span class="fc" id="L192">            .remarks(transaction.getRemarks())</span>
<span class="fc" id="L193">            .build();</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>
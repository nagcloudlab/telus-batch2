#!/bin/bash

# Update NVD CVE Database
# Level 9: Security Analysis - SAST

set -e

echo "═══════════════════════════════════════════════════"
echo "  Update NVD CVE Database"
echo "═══════════════════════════════════════════════════"
echo ""

# Colors
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

print_status() {
    echo -e "${BLUE}➜${NC} $1"
}

print_success() {
    echo -e "${GREEN}✅${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}⚠️${NC}  $1"
}

# Check if Maven is installed
if ! command -v mvn &> /dev/null; then
    echo "Maven not found. Please install Maven 3.6+"
    exit 1
fi

# Check database location
DB_DIR="$HOME/.m2/repository/org/owasp/dependency-check-data"

if [ -d "$DB_DIR" ]; then
    print_status "Existing database found at: $DB_DIR"
    
    # Show database info
    DB_SIZE=$(du -sh "$DB_DIR" 2>/dev/null | cut -f1)
    print_status "Current database size: $DB_SIZE"
    
    # Get last modified date
    if [ -f "$DB_DIR/odc.mv.db" ]; then
        LAST_MODIFIED=$(stat -f "%Sm" -t "%Y-%m-%d %H:%M" "$DB_DIR/odc.mv.db" 2>/dev/null || stat -c "%y" "$DB_DIR/odc.mv.db" 2>/dev/null | cut -d' ' -f1,2 | cut -d'.' -f1)
        print_status "Last updated: $LAST_MODIFIED"
    fi
    echo ""
else
    print_warning "No existing database found"
    print_status "This will be a fresh download (~1.5 GB)"
    print_warning "This may take 5-10 minutes..."
    echo ""
fi

# Confirm update
read -p "Update NVD database now? (y/n) " -n 1 -r
echo
if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    echo "Update cancelled"
    exit 0
fi

echo ""
print_status "Updating NVD database..."
print_status "This fetches the latest CVE data from NIST..."
echo ""

# Run update
mvn dependency-check:update-only

if [ $? -eq 0 ]; then
    echo ""
    print_success "Database update complete!"
    
    # Show new size
    if [ -d "$DB_DIR" ]; then
        NEW_SIZE=$(du -sh "$DB_DIR" 2>/dev/null | cut -f1)
        print_status "Database size: $NEW_SIZE"
    fi
    
    echo ""
    print_status "Next steps:"
    echo "  1. Run security scan: ./scripts/run-security-scan.sh"
    echo "  2. Or use: mvn dependency-check:check"
    echo ""
else
    echo ""
    print_warning "Database update failed or had warnings"
    print_status "The database may still be usable"
    print_status "Try running: mvn dependency-check:check"
    echo ""
fi

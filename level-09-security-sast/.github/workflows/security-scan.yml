name: Security Scan (SAST)

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    types: [opened, synchronize, reopened]
  schedule:
    - cron: '0 0 * * 0'  # Weekly scan on Sundays at midnight

jobs:
  security-analysis:
    name: SAST Security Analysis
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven
      
      - name: Cache Maven packages
        uses: actions/cache@v3
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-
      
      - name: Cache NVD Database
        uses: actions/cache@v3
        with:
          path: ~/.m2/repository/org/owasp/dependency-check-data
          key: ${{ runner.os }}-nvd-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-nvd-
      
      - name: Update NVD Database
        run: mvn dependency-check:update-only
        continue-on-error: true
      
      - name: Build and Test
        run: mvn clean verify -DskipTests=false
      
      - name: Run SpotBugs Analysis
        run: mvn spotbugs:check
        continue-on-error: true
      
      - name: Run OWASP Dependency-Check
        run: mvn dependency-check:check
        continue-on-error: true
      
      - name: Upload SpotBugs Report
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: spotbugs-report
          path: target/spotbugs/
          retention-days: 30
      
      - name: Upload OWASP Report  
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: owasp-dependency-check-report
          path: |
            target/dependency-check-report.html
            target/dependency-check-report.json
          retention-days: 30
      
      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: test-results
          path: target/surefire-reports/
          retention-days: 30
      
      - name: Upload Coverage Reports
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: coverage-reports
          path: target/site/jacoco/
          retention-days: 30
      
      - name: Analyze Security Results
        if: always()
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Security Analysis Complete"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          # Check if SpotBugs report exists
          if [ -f target/spotbugs/spotbugs.xml ]; then
            BUGS=$(grep -c "<BugInstance" target/spotbugs/spotbugs.xml || echo "0")
            echo "SpotBugs Issues: $BUGS"
            
            if [ "$BUGS" -gt 0 ]; then
              echo "âš ï¸  SpotBugs found $BUGS issue(s)"
              exit 1
            else
              echo "âœ… SpotBugs: No issues found"
            fi
          fi
          
          # Check if OWASP report exists
          if [ -f target/dependency-check-report.json ]; then
            VULNS=$(jq '.dependencies[].vulnerabilities | length' target/dependency-check-report.json 2>/dev/null | awk '{s+=$1} END {print s}' || echo "0")
            echo "OWASP Vulnerabilities: $VULNS"
            
            if [ "$VULNS" -gt 0 ]; then
              echo "âš ï¸  OWASP found $VULNS vulnerability(ies)"
              exit 1
            else
              echo "âœ… OWASP: No vulnerabilities found"
            fi
          fi
          
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âœ… All security checks passed!"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      
      - name: Comment PR with Results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            let comment = '## ğŸ”’ Security Analysis Results\n\n';
            
            // SpotBugs results
            if (fs.existsSync('target/spotbugs/spotbugs.xml')) {
              const content = fs.readFileSync('target/spotbugs/spotbugs.xml', 'utf8');
              const bugs = (content.match(/<BugInstance/g) || []).length;
              
              if (bugs === 0) {
                comment += 'âœ… **SpotBugs**: No issues found\n';
              } else {
                comment += `âš ï¸  **SpotBugs**: ${bugs} issue(s) found\n`;
              }
            }
            
            // OWASP results
            if (fs.existsSync('target/dependency-check-report.json')) {
              try {
                const report = JSON.parse(fs.readFileSync('target/dependency-check-report.json', 'utf8'));
                const vulns = report.dependencies.reduce((sum, dep) => 
                  sum + (dep.vulnerabilities ? dep.vulnerabilities.length : 0), 0);
                
                if (vulns === 0) {
                  comment += 'âœ… **OWASP Dependency-Check**: No vulnerabilities found\n';
                } else {
                  comment += `âš ï¸  **OWASP Dependency-Check**: ${vulns} vulnerability(ies) found\n`;
                }
              } catch (e) {
                comment += 'âš ï¸  **OWASP Dependency-Check**: Could not parse results\n';
              }
            }
            
            comment += '\nğŸ“Š Detailed reports available in workflow artifacts.';
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
